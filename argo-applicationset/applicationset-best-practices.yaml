# ArgoCD ApplicationSet ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤ ì™„ì „ ì •ë³µ
# 23ë…„ì°¨ DevOps ì—”ì§€ë‹ˆì–´ë¥¼ ìœ„í•œ ì‹¤ë¬´ íŒ¨í„´ ëª¨ìŒì§‘ ğŸš€

---
# 1. ğŸ† Production-Ready ApplicationSet (ë‹¤ì¤‘ í™˜ê²½)
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: microservices-multi-env
  namespace: argocd
  labels:
    app.kubernetes.io/name: microservices
    app.kubernetes.io/part-of: platform
    environment: multi
  annotations:
    # ì¤‘ìš”í•œ ë©”íƒ€ë°ì´í„° ì¶”ê°€
    applicationset.argoproj.io/description: "Multi-environment microservices deployment"
    applicationset.argoproj.io/owner: "platform-team"
    applicationset.argoproj.io/last-updated: "2024-12-21"
spec:
  # ğŸ”„ ë™ê¸°í™” ì •ì±… (ì´ê±° ê¼­ ì„¤ì •í•´!)
  syncPolicy:
    preserveResourcesOnDeletion: true  # Application ì‚­ì œ ì‹œ ë¦¬ì†ŒìŠ¤ ë³´ì¡´
    applicationsSync: sync  # ìƒì„±ëœ Applicationë“¤ ìë™ ë™ê¸°í™”
  
  # ğŸ¯ Matrix Generator (í™˜ê²½ x ì„œë¹„ìŠ¤ ì¡°í•©)
  generators:
  - matrix:
      generators:
      # í™˜ê²½ ëª©ë¡
      - list:
          elements:
          - env: dev
            cluster: https://kubernetes.default.svc
            replicaCount: "1"
            resources.cpu: "100m"
            resources.memory: "128Mi"
            domain: "dev.company.com"
            targetRevision: develop
          - env: staging
            cluster: https://staging-cluster.company.com
            replicaCount: "2"
            resources.cpu: "200m"
            resources.memory: "256Mi"
            domain: "staging.company.com"
            targetRevision: release/v1.0
          - env: prod
            cluster: https://prod-cluster.company.com
            replicaCount: "3"
            resources.cpu: "500m"
            resources.memory: "512Mi"
            domain: "company.com"
            targetRevision: v1.0.0  # ìš´ì˜ì€ íƒœê·¸ë¡œ!
      
      # ì„œë¹„ìŠ¤ ëª©ë¡
      - list:
          elements:
          - name: user-service
            namespace: backend
            port: "8080"
            healthPath: "/health"
            team: backend-team
          - name: order-service
            namespace: backend
            port: "8081"
            healthPath: "/actuator/health"
            team: backend-team
          - name: payment-service
            namespace: backend
            port: "8082"
            healthPath: "/health"
            team: payment-team
          - name: notification-service
            namespace: notification
            port: "8083"
            healthPath: "/health"
            team: platform-team
          - name: frontend
            namespace: frontend
            port: "3000"
            healthPath: "/api/health"
            team: frontend-team

  # ğŸ“ Application í…œí”Œë¦¿
  template:
    metadata:
      name: '{{ name }}-{{ env }}'
      namespace: argocd
      labels:
        app.kubernetes.io/name: '{{ name }}'
        app.kubernetes.io/instance: '{{ name }}-{{ env }}'
        app.kubernetes.io/component: microservice
        app.kubernetes.io/part-of: platform
        environment: '{{ env }}'
        team: '{{ team }}'
      annotations:
        # ğŸ”” ì•Œë¦¼ ì„¤ì • (í™˜ê²½ë³„ë¡œ ë‹¤ë¥´ê²Œ)
        notifications.argoproj.io/subscribe.on-sync-failed.slack: '{{ team }}-alerts'
        notifications.argoproj.io/subscribe.on-health-degraded.slack: '{{ team }}-alerts'
        # ìš´ì˜í™˜ê²½ë§Œ íŠ¹ë³„ ì•Œë¦¼
        '{{- if eq .env "prod" }}'
        notifications.argoproj.io/subscribe.on-sync-succeeded.slack: 'prod-deployments'
        '{{- end }}'
        # Git ì •ë³´ ì¶”ê°€
        app.kubernetes.io/git-repo: 'https://github.com/company/microservices'
        app.kubernetes.io/git-revision: '{{ targetRevision }}'
        
      # ğŸ·ï¸ Finalizer ì„¤ì • (ì¤‘ìš”!)
      finalizers:
      - resources-finalizer.argocd.argoproj.io
      
    spec:
      project: '{{ env }}-project'  # í™˜ê²½ë³„ í”„ë¡œì íŠ¸ ë¶„ë¦¬
      
      source:
        repoURL: https://github.com/company/microservices.git
        targetRevision: '{{ targetRevision }}'
        path: 'charts/{{ name }}'
        helm:
          releaseName: '{{ name }}'
          valueFiles:
          - values.yaml
          - 'environments/{{ env }}/values.yaml'
          - 'environments/{{ env }}/{{ name }}-values.yaml'
          
          # ğŸ›ï¸ í™˜ê²½ë³„ ë§¤ê°œë³€ìˆ˜ ì˜¤ë²„ë¼ì´ë“œ
          parameters:
          - name: image.tag
            value: '{{ targetRevision }}'
          - name: replicaCount
            value: '{{ replicaCount }}'
          - name: resources.requests.cpu
            value: '{{ resources.cpu }}'
          - name: resources.requests.memory
            value: '{{ resources.memory }}'
          - name: service.port
            value: '{{ port }}'
          - name: ingress.host
            value: '{{ name }}.{{ domain }}'
          - name: healthCheck.path
            value: '{{ healthPath }}'
          - name: environment
            value: '{{ env }}'
            
      destination:
        server: '{{ cluster }}'
        namespace: '{{ namespace }}-{{ env }}'  # í™˜ê²½ë³„ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë¶„ë¦¬
        
      # âš™ï¸ í™˜ê²½ë³„ ë™ê¸°í™” ì •ì±…
      syncPolicy:
        # ê°œë°œí™˜ê²½ë§Œ ìë™ ë™ê¸°í™”
        '{{- if eq .env "dev" }}'
        automated:
          prune: true
          selfHeal: true
        '{{- else }}'
        # ìŠ¤í…Œì´ì§•/ìš´ì˜ì€ ìˆ˜ë™ ë™ê¸°í™”
        automated: {}
        '{{- end }}'
        
        syncOptions:
        - CreateNamespace=true
        - PrunePropagationPolicy=foreground
        - PruneLast=true
        - RespectIgnoreDifferences=true
        
        # ğŸ”„ ì¬ì‹œë„ ì •ì±…
        retry:
          limit: 5
          backoff:
            duration: 5s
            factor: 2
            maxDuration: 3m
            
      # ğŸš« ë¬´ì‹œí•  ì°¨ì´ì ë“¤
      ignoreDifferences:
      - group: apps
        kind: Deployment
        jsonPointers:
        - /spec/replicas
      - group: ""
        kind: Service
        jsonPointers:
        - /spec/clusterIP

---
# 2. ğŸŒ Git Directories Generator (ëª¨ë…¸ë ˆí¬ íŒ¨í„´)
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: monorepo-services
  namespace: argocd
  labels:
    pattern: monorepo
spec:
  syncPolicy:
    preserveResourcesOnDeletion: true
    
  generators:
  # Git ë””ë ‰í† ë¦¬ ê¸°ë°˜ ìë™ ë°œê²¬
  - git:
      repoURL: https://github.com/company/monorepo.git
      revision: main
      directories:
      - path: services/*/
      - path: infrastructure/*/
        exclude: infrastructure/docs  # ì œì™¸í•  ë””ë ‰í† ë¦¬
      
      # ğŸ·ï¸ ë””ë ‰í† ë¦¬ë³„ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
      template:
        metadata:
          name: 'monorepo-{{path.basename}}'
          labels:
            source-path: '{{path}}'
            
  template:
    metadata:
      name: 'monorepo-{{path.basename}}'
      labels:
        app.kubernetes.io/name: '{{path.basename}}'
        source.type: monorepo
        
    spec:
      project: default
      source:
        repoURL: https://github.com/company/monorepo.git
        targetRevision: main
        path: '{{path}}'
        
      destination:
        server: https://kubernetes.default.svc
        namespace: '{{path.basename}}'
        
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
        - CreateNamespace=true

---
# 3. ğŸ¯ Cluster Generator (ë‹¤ì¤‘ í´ëŸ¬ìŠ¤í„° ë°°í¬)
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: multi-cluster-apps
  namespace: argocd
  labels:
    pattern: multi-cluster
spec:
  generators:
  # í´ëŸ¬ìŠ¤í„° ê¸°ë°˜ ìƒì„±
  - clusters:
      selector:
        matchLabels:
          environment: production  # ìš´ì˜ í´ëŸ¬ìŠ¤í„°ë§Œ ëŒ€ìƒ
        matchExpressions:
        - key: cluster-type
          operator: In
          values: ["workload", "compute"]
      
      # ğŸ·ï¸ í´ëŸ¬ìŠ¤í„°ë³„ ì„¤ì • ì˜¤ë²„ë¼ì´ë“œ
      template:
        metadata:
          name: 'multi-app-{{name}}'
          labels:
            cluster-name: '{{name}}'
            cluster-region: '{{metadata.labels.region}}'
            
      values:
        clusterName: '{{name}}'
        region: '{{metadata.labels.region}}'
        nodeCount: '{{metadata.annotations.node-count}}'
        
  template:
    metadata:
      name: 'monitoring-{{values.clusterName}}'
      
    spec:
      project: infrastructure
      source:
        repoURL: https://github.com/company/infrastructure.git
        targetRevision: main
        path: monitoring/
        helm:
          parameters:
          - name: cluster.name
            value: '{{values.clusterName}}'
          - name: cluster.region
            value: '{{values.region}}'
          - name: nodeCount
            value: '{{values.nodeCount}}'
            
      destination:
        server: '{{server}}'
        namespace: monitoring
        
      syncPolicy:
        automated:
          prune: true
          selfHeal: true

---
# 4. ğŸ”„ Pull Request Generator (GitOps Preview)
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: pr-preview-apps
  namespace: argocd
  labels:
    pattern: pr-preview
spec:
  generators:
  # GitHub PR ê¸°ë°˜ ìƒì„±
  - pullRequest:
      github:
        # GitHub ì„¤ì •
        owner: company
        repo: microservices
        tokenRef:
          secretName: github-token
          key: token
        # PR ì¡°ê±´
        labels:
        - preview  # 'preview' ë¼ë²¨ì´ ìˆëŠ” PRë§Œ
      
      # ğŸ·ï¸ PR ì •ë³´ ì¶”ì¶œ
      template:
        metadata:
          name: 'pr-{{number}}-{{branch_slug}}'
          labels:
            preview: "true"
            pr-number: '{{number}}'
            
  template:
    metadata:
      name: 'preview-{{branch_slug}}-{{number}}'
      labels:
        app.kubernetes.io/name: preview-app
        pr.number: '{{number}}'
        pr.branch: '{{branch}}'
      annotations:
        # PR ë§í¬ ì¶”ê°€
        pr.github.com/url: '{{github.com/company/microservices/pull/{{number}}}}'
        # ìë™ ì •ë¦¬ ì„¤ì • (7ì¼ í›„)
        janitor/ttl: "168h"
        
    spec:
      project: preview
      source:
        repoURL: https://github.com/company/microservices.git
        targetRevision: '{{head_sha}}'  # PRì˜ ìµœì‹  ì»¤ë°‹
        path: chart/
        helm:
          parameters:
          - name: image.tag
            value: 'pr-{{number}}'
          - name: ingress.host
            value: 'pr-{{number}}.preview.company.com'
          - name: resources.requests.cpu
            value: "50m"  # PreviewëŠ” ë¦¬ì†ŒìŠ¤ ì œí•œ
          - name: resources.requests.memory
            value: "64Mi"
            
      destination:
        server: https://kubernetes.default.svc
        namespace: 'preview-{{number}}'
        
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
        - CreateNamespace=true

---
# 5. ğŸ›ï¸ SCM Provider Generator (Organization ì „ì²´)
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: org-wide-apps
  namespace: argocd
  labels:
    pattern: organization-wide
spec:
  generators:
  # GitHub Organization ì „ì²´ ìŠ¤ìº”
  - scmProvider:
      github:
        organization: company
        tokenRef:
          secretName: github-token
          key: token
        # í•„í„° ì¡°ê±´
        allBranches: false  # ê¸°ë³¸ ë¸Œëœì¹˜ë§Œ
        api: https://api.github.com
      
      # ğŸ·ï¸ ì €ì¥ì†Œ ì¡°ê±´ í•„í„°
      filters:
      - repositoryMatch: ".*-service$"  # '-service'ë¡œ ëë‚˜ëŠ” ì €ì¥ì†Œë§Œ
      - pathsExist: ["helm/Chart.yaml"]  # Helm ì°¨íŠ¸ê°€ ìˆëŠ” ì €ì¥ì†Œë§Œ
      - branchMatch: "main|master"       # ê¸°ë³¸ ë¸Œëœì¹˜ë§Œ
      
  template:
    metadata:
      name: '{{repository}}'
      labels:
        app.kubernetes.io/name: '{{repository}}'
        scm.organization: '{{organization}}'
        
    spec:
      project: auto-discovered
      source:
        repoURL: '{{url}}'
        targetRevision: '{{branch}}'
        path: helm/
        
      destination:
        server: https://kubernetes.default.svc
        namespace: '{{repository}}'
        
      syncPolicy:
        automated:
          prune: true
          selfHeal: false  # ìë™ ë°œê²¬ëœ ì•±ì€ ì‹ ì¤‘í•˜ê²Œ

---
# 6. ğŸ”§ Progressive Rollout ApplicationSet
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: progressive-rollout
  namespace: argocd
  labels:
    pattern: progressive-rollout
spec:
  # ğŸ• ì ì§„ì  ë¡¤ì•„ì›ƒì„ ìœ„í•œ ì‹œê°„ ì§€ì—°
  syncPolicy:
    preserveResourcesOnDeletion: true
    
  generators:
  - list:
      elements:
      # Wave 1: Canary í™˜ê²½ (ì¦‰ì‹œ)
      - name: payment-service
        environment: canary
        weight: "10"
        delay: "0s"
        cluster: https://canary-cluster.company.com
        
      # Wave 2: ìŠ¤í…Œì´ì§• (5ë¶„ í›„)
      - name: payment-service
        environment: staging
        weight: "50"
        delay: "300s"
        cluster: https://staging-cluster.company.com
        
      # Wave 3: ìš´ì˜ (15ë¶„ í›„)
      - name: payment-service
        environment: production
        weight: "100"
        delay: "900s"
        cluster: https://prod-cluster.company.com
        
  template:
    metadata:
      name: '{{name}}-{{environment}}'
      annotations:
        # â° ì§€ì—° ë°°í¬ ì„¤ì •
        argocd.argoproj.io/sync-wave: '{{delay}}'
        
    spec:
      project: progressive
      source:
        repoURL: https://github.com/company/payment-service.git
        targetRevision: main
        path: helm/
        helm:
          parameters:
          - name: environment
            value: '{{environment}}'
          - name: trafficWeight
            value: '{{weight}}'
            
      destination:
        server: '{{cluster}}'
        namespace: payment-{{environment}}
        
      # ğŸš¨ í™˜ê²½ë³„ ë™ê¸°í™” ì •ì±…
      syncPolicy:
        '{{- if eq .environment "canary" }}'
        automated:
          prune: true
          selfHeal: true
        '{{- else }}'
        # ìŠ¤í…Œì´ì§•/ìš´ì˜ì€ ìˆ˜ë™ ìŠ¹ì¸ í›„ ì§„í–‰
        automated: {}
        '{{- end }}'

---
# 7. ğŸ›¡ï¸ Security & Compliance ApplicationSet
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: security-compliance
  namespace: argocd
  labels:
    pattern: security
    compliance.level: high
spec:
  syncPolicy:
    preserveResourcesOnDeletion: true
    
  generators:
  - list:
      elements:
      - name: network-policies
        namespace: kube-system
        priority: "1"
        compliance: "required"
      - name: pod-security-standards
        namespace: kube-system
        priority: "1"
        compliance: "required"
      - name: falco-security
        namespace: security
        priority: "2"
        compliance: "recommended"
      - name: opa-gatekeeper
        namespace: gatekeeper
        priority: "2"
        compliance: "required"
        
  template:
    metadata:
      name: 'security-{{name}}'
      labels:
        app.kubernetes.io/name: '{{name}}'
        security.compliance: '{{compliance}}'
        deployment.priority: '{{priority}}'
      annotations:
        # ğŸ”’ ë³´ì•ˆ ê´€ë ¨ íŠ¹ë³„ ì„¤ì •
        argocd.argoproj.io/sync-wave: '{{priority}}'
        security.policy/enforce: "true"
        
    spec:
      project: security
      source:
        repoURL: https://github.com/company/security-policies.git
        targetRevision: main
        path: '{{name}}/'
        
      destination:
        server: https://kubernetes.default.svc
        namespace: '{{namespace}}'
        
      # ğŸ” ë³´ì•ˆ ì•±ì€ ì—„ê²©í•œ ë™ê¸°í™” ì •ì±…
      syncPolicy:
        # ë³´ì•ˆ ì •ì±…ì€ ìˆ˜ë™ ë™ê¸°í™”
        automated: {}
        syncOptions:
        - CreateNamespace=true
        - Validate=true
        - ServerSideApply=true
        - Replace=false
        
        # ğŸ”„ ì—„ê²©í•œ ì¬ì‹œë„ ì •ì±…
        retry:
          limit: 3
          backoff:
            duration: 10s
            maxDuration: 1m

---
# ğŸ“‹ ApplicationSet Best Practices ì²´í¬ë¦¬ìŠ¤íŠ¸
#
# âœ… ë©”íƒ€ë°ì´í„° ê´€ë¦¬:
# â”œâ”€â”€ ëª…í™•í•œ ë¼ë²¨ë§ ì „ëµ
# â”œâ”€â”€ ì†Œìœ ì ì •ë³´ í¬í•¨
# â”œâ”€â”€ ìƒì„±/ìˆ˜ì • ë‚ ì§œ ì¶”ì 
# â””â”€â”€ ëª©ì ê³¼ íŒ¨í„´ ëª…ì‹œ
#
# âœ… ë³´ì•ˆ ê³ ë ¤ì‚¬í•­:
# â”œâ”€â”€ ë¯¼ê°í•œ ì •ë³´ëŠ” Secret ì‚¬ìš©
# â”œâ”€â”€ RBAC ê¶Œí•œ ìµœì†Œí™”
# â”œâ”€â”€ Git í† í° ìˆœí™˜ ì •ì±…
# â””â”€â”€ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë¶„ë¦¬
#
# âœ… ìš´ì˜ ê´€ë¦¬:
# â”œâ”€â”€ í™˜ê²½ë³„ ë™ê¸°í™” ì •ì±… ì°¨ë³„í™”
# â”œâ”€â”€ ì ì ˆí•œ ì¬ì‹œë„ ì •ì±…
# â”œâ”€â”€ ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì •ì±…
# â””â”€â”€ ëª¨ë‹ˆí„°ë§ ë° ì•Œë¦¼ ì„¤ì •
#
# âœ… ì„±ëŠ¥ ìµœì í™”:
# â”œâ”€â”€ Generator í•„í„° ìµœì í™”
# â”œâ”€â”€ ë¶ˆí•„ìš”í•œ Application ìƒì„± ë°©ì§€
# â”œâ”€â”€ ë™ê¸°í™” ë¹ˆë„ ì¡°ì ˆ
# â””â”€â”€ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§
#
# âœ… ì—ëŸ¬ ì²˜ë¦¬:
# â”œâ”€â”€ ì‹¤íŒ¨ ì‹œ ì•Œë¦¼ ì„¤ì •
# â”œâ”€â”€ ë¡¤ë°± ì „ëµ ìˆ˜ë¦½
# â”œâ”€â”€ ì˜ì¡´ì„± ê´€ë¦¬
# â””â”€â”€ ì¥ì•  ê²©ë¦¬ ë°©ì•ˆ 